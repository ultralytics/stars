# Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

# List Open PRs across Ultralytics repositories
# This workflow scans all public repos in the Ultralytics organization and lists open PRs
# For popular repos (>100 stars), only the 5 most recent open PRs are shown

name: List Open PRs

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  list-prs:
    runs-on: ubuntu-latest
    steps:
      - name: List open PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Open Pull Requests - Ultralytics Organization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get all public repos
          REPOS=$(gh repo list ultralytics --limit 1000 --json name,stargazerCount,url --visibility public)
          
          # Process each repo
          echo "$REPOS" | jq -r '.[] | "\(.name)|\(.stargazerCount)|\(.url)"' | while IFS='|' read -r name stars url; do
            # Determine PR limit (5 for popular repos with >100 stars)
            LIMIT=1000
            if [ "$stars" -gt 100 ]; then
              LIMIT=5
            fi
            
            # Get open PRs
            PRS=$(gh pr list --repo "ultralytics/$name" --limit "$LIMIT" --json number,title,url,createdAt --state open 2>/dev/null || echo "[]")
            PR_COUNT=$(echo "$PRS" | jq '. | length')
            
            if [ "$PR_COUNT" -gt 0 ]; then
              echo "## [$name]($url) - $PR_COUNT open PR(s)" >> $GITHUB_STEP_SUMMARY
              echo "$PRS" | jq -r '.[] | "- [#\(.number)](\(.url)) \(.title)"' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
